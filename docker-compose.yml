version: "2"

services:

    db_old:
        image: mysql:5.7
        expose:
            - "3306"
        volumes:
            - ./db/old/init:/docker-entrypoint-initdb.d:ro
            - ./db/old/data:/var/lib/mysql
            - ./mysql.cnf:/etc/mysql/conf.d/mysql.cnf:ro
        environment:
            MYSQL_ROOT_PASSWORD: "abc123"

    db_old_admin:
        image: phpmyadmin/phpmyadmin:latest
        links:
            - db_old:db
        ports:
            - "8081:80"
        environment:
            MYSQL_ROOT_PASSWORD: "abc123"
    db_new:
        image: postgres:9.4
        expose:
            - "5432"
        volumes:
            - ./db/new/init:/docker-entrypoint-initdb.d:ro
            - ./db/new/data:/var/lib/postgres/data/pgdata
        environment:
            POSTGRES_PASSWORD: "abc123"
            PGDATA: "/var/lib/postgres/data/pgdata"
    
    app:
        image: jlabusch/moodle-log-migrator
        build: .
        links:
            - db_old
            - db_new
        volumes:
            - ./lib:/opt/lib:ro
            - ./db:/opt/data
        environment:
            RESTRICT_MODULES: "resource"
            RESTRICT_ACTIONS: "view all"
            LOSSY_AUDIT: "yes"
            # DISABLE_AUDIT: "yes"
            